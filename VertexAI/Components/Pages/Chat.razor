@page "/"
@rendermode InteractiveServer
@inject GeminiService Gemini
@inject MarkdownService Markdown
@inject AuthService Auth
@inject ConversationService ConversationSvc
@inject NavigationManager Navigation
@inject IJSRuntime JS

@if (!_initialized)
{
    <div class="h-dvh flex items-center justify-center bg-amber-50">
        <div class="text-amber-600">加载中...</div>
    </div>
}
else if (!Auth.IsAuthenticated)
{
    <div class="h-dvh flex items-center justify-center bg-amber-50">
        <div class="text-center">
            <p class="text-amber-600 mb-4">请先登录</p>
            <a href="/login" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">登录</a>
        </div>
    </div>
}
else
{
    <div class="h-dvh flex">
        @* 侧边栏 - 对话列表 *@
        <aside class="@(_showSidebar ? "w-64" : "w-0") flex-shrink-0 bg-amber-100 border-r border-amber-200 flex flex-col transition-all duration-300 overflow-hidden">
            <div class="p-3 border-b border-amber-200 flex items-center justify-between">
                <span class="font-bold text-amber-800">对话历史</span>
                <button @onclick="CreateNewConversation" class="p-1 hover:bg-amber-200 rounded" title="新对话">
                    <svg class="w-5 h-5 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto">
                @foreach (var conv in _conversations)
                {
                    <button @onclick="() => LoadConversation(conv.Id)"
                            class="w-full text-left px-3 py-2 text-sm hover:bg-amber-200 transition-colors truncate @(_currentConversationId == conv.Id ? "bg-amber-200" : "")">
                        @(conv.Title ?? "新对话")
                    </button>
                }
            </div>
            <div class="p-3 border-t border-amber-200">
                <button @onclick="SignOut" class="w-full text-left text-sm text-amber-700 hover:text-amber-900">
                    退出登录 (@Auth.CurrentUser.Email)
                </button>
            </div>
        </aside>

        @* 主内容区 *@
        <div class="flex-1 flex flex-col min-w-0">
            <header class="flex-shrink-0 bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-3 shadow-md safe-area-top">
                <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 min-w-0">
                        <button @onclick="ToggleSidebar" class="p-1 text-white hover:bg-white/20 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <h1 class="text-lg font-bold text-white">Gemini</h1>
                        @* 预设选择器 *@
                        <div class="relative">
                            <button @onclick="TogglePresetMenu"
                                    class="flex items-center gap-1 px-2 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-white text-xs">
                                <span class="truncate max-w-[80px]">@GetCurrentPresetName()</span>
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            </button>
                            @if (_showPresetMenu)
                            {
                                <div class="absolute top-full left-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-amber-200 z-50">
                                    @foreach (var preset in GeminiService.Presets.Where(p => p.Id != "custom"))
                                    {
                                        <button @onclick="() => SelectPreset(preset.Id)"
                                                class="w-full flex items-center gap-3 px-4 py-3 hover:bg-amber-50 text-left @(Gemini.CurrentPresetId == preset.Id ? "bg-amber-100" : "")">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-gray-800">@preset.Name</div>
                                                <div class="text-xs text-gray-500 truncate">@preset.Description</div>
                                            </div>
                                        </button>
                                    }
                                    <hr class="border-amber-200" />
                                    <button @onclick="ShowCustomPromptDialog"
                                            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-amber-50 text-left">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800">自定义提示词</div>
                                        </div>
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-white/80 font-mono">@FormatTokenCount(Gemini.CurrentTokenCount)/@FormatTokenCount(Gemini.MaxTokens)</span>
                        <button @onclick="ClearChat" class="px-2 py-1 text-xs text-white/80 hover:bg-white/10 rounded">清空</button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto px-3 py-4 bg-amber-50" id="messages-container" @onclick="CloseMenus">
                <div class="max-w-4xl mx-auto space-y-4">
                    @if (_messages.Count == 0)
                    {
                        <div class="text-center py-16">
                            <p class="text-amber-700 font-medium">@GetCurrentPresetName()</p>
                            <p class="text-sm text-amber-500 mt-2">开始对话吧</p>
                        </div>
                    }

                    @foreach (var msg in _messages)
                    {
                        <div class="@(msg.IsUser ? "flex justify-end" : "flex justify-start")">
                            <div class="max-w-[90%] @(msg.IsUser ? "bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl rounded-br-md" : "bg-white border border-amber-200 text-gray-800 rounded-2xl rounded-bl-md shadow-sm") px-3 py-2">
                                @if (!msg.IsUser && msg.ThinkingContent?.Length > 0)
                                {
                                    <details class="mb-2 group">
                                        <summary class="cursor-pointer text-xs text-amber-700">思考过程 (@msg.ThinkingContent.Length 字符)</summary>
                                        <div class="mt-2 pl-3 text-xs text-amber-800 border-l-2 border-amber-300 whitespace-pre-wrap">@msg.ThinkingContent</div>
                                    </details>
                                }
                                @if (msg.IsUser)
                                {
                                    <div class="whitespace-pre-wrap break-words text-sm">@msg.Content</div>
                                }
                                else
                                {
                                    <div class="markdown-body text-sm">
                                        @((MarkupString)Markdown.ToHtml(msg.Content))
                                        @if (msg.IsStreaming)
                                        {
                                            <span class="inline-block w-2 h-4 bg-amber-600 ml-1 cursor-blink"></span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @if (_isLoading && !_messages.Any(m => m.IsStreaming))
                    {
                        <div class="flex justify-start">
                            <div class="bg-white border border-amber-200 rounded-2xl px-3 py-2 shadow-sm">
                                <span class="text-amber-700 text-sm thinking-pulse">思考中...</span>
                            </div>
                        </div>
                    }
                </div>
            </main>

            <footer class="flex-shrink-0 bg-white border-t border-amber-200 px-3 py-3 safe-area-bottom">
                <form @onsubmit="SendMessage" class="max-w-4xl mx-auto flex gap-2">
                    <input @bind="_inputMessage" @bind:event="oninput" @onkeydown="HandleKeyDown"
                           type="text" placeholder="输入消息..." disabled="@_isLoading"
                           class="flex-1 bg-amber-50 border border-amber-300 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-amber-400" />
                    <button type="submit" disabled="@(string.IsNullOrWhiteSpace(_inputMessage) || _isLoading)"
                            class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-medium rounded-xl disabled:opacity-50">
                        发送
                    </button>
                </form>
            </footer>
        </div>
    </div>
}

@* 自定义提示词对话框 *@
@if (_showCustomDialog)
{
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @onclick="CloseCustomDialog">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg" @onclick:stopPropagation>
            <div class="px-6 py-4 border-b border-amber-200">
                <h2 class="text-lg font-bold text-gray-800">自定义系统提示词</h2>
            </div>
            <div class="p-6">
                <textarea @bind="_customPromptInput" rows="6" placeholder="输入自定义的 AI 人设提示词..."
                          class="w-full bg-amber-50 border border-amber-300 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:ring-2 focus:ring-amber-400 resize-none"></textarea>
            </div>
            <div class="px-6 py-4 border-t border-amber-200 flex justify-end gap-3">
                <button @onclick="CloseCustomDialog" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">取消</button>
                <button @onclick="ApplyCustomPrompt" disabled="@string.IsNullOrWhiteSpace(_customPromptInput)"
                        class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-medium rounded-lg disabled:opacity-50">
                    应用
                </button>
            </div>
        </div>
    </div>
}

<style>
    .safe-area-top { padding-top: max(env(safe-area-inset-top), 0.75rem); }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 0.75rem); }
    .h-dvh { height: 100dvh; }
    .cursor-blink { animation: blink 1s step-end infinite; }
    @@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .thinking-pulse { animation: pulse 1.5s ease-in-out infinite; }
    @@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>

@code {
    private readonly List<ChatMessage> _messages = [];
    private List<Data.Entities.Conversation> _conversations = [];
    private Guid? _currentConversationId;
    private string _inputMessage = "";
    private bool _isLoading;
    private bool _initialized;
    private bool _showSidebar = true;
    private bool _showPresetMenu;
    private bool _showCustomDialog;
    private string _customPromptInput = "";

    protected override async Task OnInitializedAsync()
    {
        await Auth.InitializeAsync();
        if (Auth.IsAuthenticated)
        {
            await LoadConversationsAsync();
        }
        _initialized = true;
    }

    private async Task LoadConversationsAsync()
    {
        _conversations = await ConversationSvc.GetUserConversationsAsync(Auth.CurrentUser.Id);
    }

    private async Task CreateNewConversation()
    {
        var conv = await ConversationSvc.CreateConversationAsync(
            Auth.CurrentUser.Id, Gemini.CurrentPresetId, Gemini.CurrentCustomPrompt);
        _currentConversationId = conv?.Id; // 可能为 null（离线模式）
        _messages.Clear();
        Gemini.ClearHistory();
        await LoadConversationsAsync();
    }

    private async Task LoadConversation(Guid conversationId)
    {
        var conv = await ConversationSvc.GetConversationAsync(conversationId, Auth.CurrentUser.Id);
        if (conv == null) return;

        _currentConversationId = conversationId;
        _messages.Clear();
        Gemini.ClearHistory();
        Gemini.SetSystemPrompt(conv.PresetId, conv.CustomPrompt);

        foreach (var msg in conv.Messages)
        {
            _messages.Add(new ChatMessage
            {
                IsUser = msg.Role == "user",
                Content = msg.Content,
                ThinkingContent = msg.ThinkingContent
            });
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) || _isLoading) return;

        // 如果没有当前对话，创建一个
        if (_currentConversationId == null)
        {
            await CreateNewConversation();
        }

        var userMessage = _inputMessage.Trim();
        _inputMessage = "";
        _isLoading = true;

        _messages.Add(new ChatMessage { IsUser = true, Content = userMessage });
        await ScrollToBottom();
        StateHasChanged();

        // 持久化用户消息（如果有对话 ID）
        if (_currentConversationId.HasValue)
        {
            await ConversationSvc.AddMessageAsync(_currentConversationId.Value, "user", userMessage);
        }

        var aiMessage = new ChatMessage { IsUser = false, Content = "", IsStreaming = true };
        _messages.Add(aiMessage);

        try
        {
            var thinkingBuilder = new System.Text.StringBuilder();
            var responseBuilder = new System.Text.StringBuilder();

            await foreach (var chunk in Gemini.StreamChatAsync(userMessage))
            {
                if (chunk.IsThinking)
                {
                    thinkingBuilder.Append(chunk.Text);
                    aiMessage.ThinkingContent = thinkingBuilder.ToString();
                }
                else
                {
                    responseBuilder.Append(chunk.Text);
                    aiMessage.Content = responseBuilder.ToString();
                }
                StateHasChanged();
                await ScrollToBottom();
            }

            // 持久化 AI 回复（如果有对话 ID）
            if (_currentConversationId.HasValue)
            {
                await ConversationSvc.AddMessageAsync(
                    _currentConversationId.Value, "model", aiMessage.Content, aiMessage.ThinkingContent);
            }
        }
        catch (Exception ex)
        {
            aiMessage.Content = $"错误: {ex.Message}";
        }
        finally
        {
            aiMessage.IsStreaming = false;
            _isLoading = false;
            await LoadConversationsAsync(); // 刷新标题
            StateHasChanged();
        }
    }

    private async Task SignOut()
    {
        await Auth.SignOutAsync();
        Navigation.NavigateTo("/login");
    }

    private void ToggleSidebar() => _showSidebar = !_showSidebar;
    private void TogglePresetMenu() => _showPresetMenu = !_showPresetMenu;
    private void CloseMenus() => _showPresetMenu = false;

    private void ClearChat()
    {
        _messages.Clear();
        Gemini.ClearHistory();
        _currentConversationId = null;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey) await SendMessage();
    }

    private async Task ScrollToBottom()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight");
    }

    private void SelectPreset(string presetId)
    {
        Gemini.SetSystemPrompt(presetId);
        _messages.Clear();
        _showPresetMenu = false;
        _currentConversationId = null;
    }

    private void ShowCustomPromptDialog()
    {
        _showPresetMenu = false;
        _showCustomDialog = true;
        _customPromptInput = Gemini.CurrentCustomPrompt;
    }

    private void CloseCustomDialog() => _showCustomDialog = false;

    private void ApplyCustomPrompt()
    {
        if (!string.IsNullOrWhiteSpace(_customPromptInput))
        {
            Gemini.SetSystemPrompt("custom", _customPromptInput);
            _messages.Clear();
            _showCustomDialog = false;
            _currentConversationId = null;
        }
    }

    private static string FormatTokenCount(int count) => count >= 1000 ? $"{count / 1000}K" : count.ToString();
    private string GetCurrentPresetName() => GeminiService.Presets.FirstOrDefault(p => p.Id == Gemini.CurrentPresetId)?.Name ?? "默认助手";

    private class ChatMessage
    {
        public bool IsUser { get; init; }
        public string Content { get; set; } = "";
        public string? ThinkingContent { get; set; }
        public bool IsStreaming { get; set; }
    }
}
