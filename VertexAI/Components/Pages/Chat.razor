@page "/"
@rendermode InteractiveServer
@inject GeminiService Gemini
@inject MarkdownService Markdown
@inject AuthService Auth
@inject ConversationService ConversationSvc
@inject ImageService ImageSvc
@inject NavigationManager Navigation
@inject IJSRuntime JS

@if (!_initialized)
{
    <div class="h-dvh flex items-center justify-center bg-amber-50">
        <div class="text-amber-600">加载中...</div>
    </div>
}
else if (!Auth.IsAuthenticated)
{
    <div class="h-dvh flex items-center justify-center bg-gradient-to-br from-sky-100 via-white to-emerald-100">
        <div class="text-center bg-white/80 backdrop-blur-xl rounded-3xl shadow-xl p-8 border border-white/50">
            <h2 class="text-xl font-bold bg-gradient-to-r from-sky-500 to-emerald-500 bg-clip-text text-transparent mb-2">Gemini Chat</h2>
            <p class="text-slate-500 mb-6">请登录后开始对话</p>
            <a href="/login" class="px-6 py-2.5 bg-gradient-to-r from-sky-400 to-emerald-400 text-white font-medium rounded-2xl hover:shadow-lg hover:shadow-sky-200/50 transition-all inline-block">登录 / 注册</a>
        </div>
    </div>
}
else
{
    <div class="h-dvh flex relative overflow-hidden">
        @* 移动端背景遮罩 *@
        @if (_showSidebar)
        {
            <div class="md:hidden absolute inset-0 bg-black/50 z-30 transition-opacity"
                 @onclick="ToggleSidebar"></div>
        }

        <ChatSidebar
            IsOpen="@_showSidebar"
            Conversations="@_conversationItems"
            CurrentConversationId="@_currentConversationId"
            UserEmail="@Auth.CurrentUser.Email"
            OnToggle="ToggleSidebar"
            OnNewConversation="StartNewChat"
            OnSelectConversation="LoadConversation"
            OnDeleteConversation="DeleteConversation"
            OnSignOut="SignOut" />

        <div class="flex-1 flex flex-col min-w-0">
            <ChatHeader
                @ref="_headerRef"
                CurrentPresetId="@Gemini.CurrentPresetId"
                CurrentPresetName="@GetCurrentPresetName()"
                Presets="@_presetItems"
                CurrentThinkingLevel="@Gemini.CurrentThinkingLevel"
                TokenCount="@Gemini.CurrentTokenCount"
                MaxTokens="@Gemini.MaxTokens"
                EmailVerified="@Auth.CurrentUser.EmailVerified"
                OnToggleSidebar="ToggleSidebar"
                OnSelectPreset="SelectPreset"
                OnShowCustomPrompt="ShowCustomPromptDialog"
                OnSelectThinkingLevel="SelectThinkingLevel"
                OnNewChat="StartNewChat" />

            <MessageList
                Messages="@_messages"
                PresetName="@GetCurrentPresetName()"
                IsLoading="@_isLoading"
                OnAreaClicked="CloseMenus"
                OnImageClick="ShowImagePreview" />

            @if (!string.IsNullOrEmpty(_validationError))
            {
                <div class="px-4 py-2 bg-red-50 border-t border-red-200 text-red-700 text-sm">
                    @_validationError
                </div>
            }

            <ChatInput
                @ref="_chatInputRef"
                InputValue="@_inputMessage"
                InputValueChanged="@((v) => _inputMessage = v)"
                IsLoading="@_isLoading"
                PendingImages="@_pendingImages"
                PendingImagesChanged="@((images) => _pendingImages = images)"
                OnFilesSelected="HandleFilesSelected"
                OnSendMessage="SendMessage" />
        </div>
    </div>
}

<CustomPromptDialog
    IsOpen="@_showCustomDialog"
    PromptValue="@_customPromptInput"
    OnClose="CloseCustomDialog"
    OnApply="ApplyCustomPrompt" />

<DeleteConfirmDialog
    IsOpen="@_showDeleteConfirm"
    OnCancel="CancelDelete"
    OnConfirm="ConfirmDelete" />

@* 切换预设确认对话框 *@
@if (_showSwitchConfirm)
{
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @onclick="CancelSwitchPreset">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm" @onclick:stopPropagation>
            <div class="px-6 py-4 border-b border-slate-200">
                <h2 class="text-lg font-bold text-slate-800">切换预设</h2>
            </div>
            <div class="p-6 text-slate-600">
                切换预设将开始新对话，当前对话已自动保存到历史记录中。是否继续？
            </div>
            <div class="px-6 py-4 border-t border-slate-200 flex justify-end gap-3">
                <button @onclick="CancelSwitchPreset" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">取消</button>
                <button @onclick="ConfirmSwitchPreset"
                        class="px-4 py-2 bg-gradient-to-r from-sky-400 to-emerald-400 text-white font-medium rounded-lg hover:shadow-lg transition-all">
                    确认切换
                </button>
            </div>
        </div>
    </div>
}

<ImagePreviewModal
    IsOpen="@_showImagePreview"
    ImageUrl="@_previewImageUrl"
    OnClose="CloseImagePreview" />

<style>
    .safe-area-top { padding-top: max(env(safe-area-inset-top), 0.75rem); }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 0.75rem); }
    .h-dvh { height: 100dvh; }
    .cursor-blink { animation: blink 1s step-end infinite; }
    @@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .thinking-pulse { animation: pulse 1.5s ease-in-out infinite; }
    @@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>



