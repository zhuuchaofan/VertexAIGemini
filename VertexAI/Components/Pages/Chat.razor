@page "/"
@rendermode InteractiveServer
@inject GeminiService Gemini
@inject MarkdownService Markdown
@inject AuthService Auth
@inject ConversationService ConversationSvc
@inject ImageService ImageSvc
@inject NavigationManager Navigation
@inject IJSRuntime JS

@if (!_initialized)
{
    <div class="h-dvh flex items-center justify-center bg-amber-50">
        <div class="text-amber-600">加载中...</div>
    </div>
}
else if (!Auth.IsAuthenticated)
{
    <div class="h-dvh flex items-center justify-center bg-amber-50">
        <div class="text-center">
            <p class="text-amber-600 mb-4">请先登录</p>
            <a href="/login" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">登录</a>
        </div>
    </div>
}
else
{
    <div class="h-dvh flex relative overflow-hidden">
        @* 移动端背景遮罩 *@
        @if (_showSidebar)
        {
            <div class="md:hidden absolute inset-0 bg-black/50 z-30 transition-opacity"
                 @onclick="ToggleSidebar"></div>
        }

        <ChatSidebar
            IsOpen="@_showSidebar"
            Conversations="@_conversationItems"
            CurrentConversationId="@_currentConversationId"
            UserEmail="@Auth.CurrentUser.Email"
            OnToggle="ToggleSidebar"
            OnNewConversation="StartNewChat"
            OnSelectConversation="LoadConversation"
            OnDeleteConversation="DeleteConversation"
            OnSignOut="SignOut" />

        <div class="flex-1 flex flex-col min-w-0">
            <ChatHeader
                @ref="_headerRef"
                CurrentPresetId="@Gemini.CurrentPresetId"
                CurrentPresetName="@GetCurrentPresetName()"
                Presets="@_presetItems"
                CurrentThinkingLevel="@Gemini.CurrentThinkingLevel"
                TokenCount="@Gemini.CurrentTokenCount"
                MaxTokens="@Gemini.MaxTokens"
                OnToggleSidebar="ToggleSidebar"
                OnSelectPreset="SelectPreset"
                OnShowCustomPrompt="ShowCustomPromptDialog"
                OnSelectThinkingLevel="SelectThinkingLevel"
                OnNewChat="StartNewChat" />

            <MessageList
                Messages="@_messages"
                PresetName="@GetCurrentPresetName()"
                IsLoading="@_isLoading"
                OnAreaClicked="CloseMenus"
                OnImageClick="ShowImagePreview" />

            @if (!string.IsNullOrEmpty(_validationError))
            {
                <div class="px-4 py-2 bg-red-50 border-t border-red-200 text-red-700 text-sm">
                    @_validationError
                </div>
            }

            <ChatInput
                @ref="_chatInputRef"
                InputValue="@_inputMessage"
                InputValueChanged="@((v) => _inputMessage = v)"
                IsLoading="@_isLoading"
                PendingImages="@_pendingImages"
                PendingImagesChanged="@((images) => _pendingImages = images)"
                OnFilesSelected="HandleFilesSelected"
                OnSendMessage="SendMessage" />
        </div>
    </div>
}

<CustomPromptDialog
    IsOpen="@_showCustomDialog"
    PromptValue="@_customPromptInput"
    OnClose="CloseCustomDialog"
    OnApply="ApplyCustomPrompt" />

<DeleteConfirmDialog
    IsOpen="@_showDeleteConfirm"
    OnCancel="CancelDelete"
    OnConfirm="ConfirmDelete" />

<ImagePreviewModal
    IsOpen="@_showImagePreview"
    ImageUrl="@_previewImageUrl"
    OnClose="CloseImagePreview" />

<style>
    .safe-area-top { padding-top: max(env(safe-area-inset-top), 0.75rem); }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 0.75rem); }
    .h-dvh { height: 100dvh; }
    .cursor-blink { animation: blink 1s step-end infinite; }
    @@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .thinking-pulse { animation: pulse 1.5s ease-in-out infinite; }
    @@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>



