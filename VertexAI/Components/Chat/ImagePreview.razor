@* 图片预览组件 - 显示待发送的图片缩略图 *@

@if (Images.Count > 0)
{
    <div class="flex flex-wrap gap-2 p-2 bg-slate-50 rounded-xl mb-2 animate-slideIn">
        @foreach (var image in Images)
        {
            <div class="relative group">
                @* 图片容器 *@
                <div class="relative w-16 h-16 rounded-lg overflow-hidden border border-slate-200 shadow-sm bg-slate-100">
                    @if (!_loadedImages.Contains(image.GetHashCode()))
                    {
                        <div class="absolute inset-0 skeleton-loading z-0"></div>
                    }

                    <img src="@image.DataUrl"
                         alt="@(image.FileName ?? "预览图片")"
                         class="w-full h-full object-cover relative z-[1]"
                         @onload="@(() => OnImageLoaded(image.GetHashCode()))"
                         @onerror="@(() => OnImageLoaded(image.GetHashCode()))" />
                </div>

                @* 删除按钮 *@
                <button type="button"
                        @onclick="() => OnRemove.InvokeAsync(image)"
                        class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center
                               sm:opacity-0 sm:group-hover:opacity-100 transition-all shadow-md hover:bg-red-600
                               hover:scale-110 active:scale-95 z-10">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        }
    </div>
}

<style>
    .animate-slideIn {
        animation: slideIn 0.25s ease-out;
    }
    @@keyframes slideIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .skeleton-loading {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    @@keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>

@code {
    [Parameter] public List<ImageAttachment> Images { get; set; } = new();
    [Parameter] public EventCallback<ImageAttachment> OnRemove { get; set; }

    private readonly HashSet<int> _loadedImages = [];

    private void OnImageLoaded(int hash)
    {
        _loadedImages.Add(hash);
        StateHasChanged();
    }
}
